<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="./highlight-theme/app.html">
<link rel="import" href="../kwc-style/typography.html">
<link rel="import" href="../kwc-style/color.html">
<link rel="import" href="../kwc-icons/kwc-icons.html">

<script src="lib/scripts/kano/make-apps/msg/en.js"></script>
<script src="lib/scripts/kano/make-apps/blockly/msg/en.js"></script>

<link rel="import" href="lib/scripts/config/web.staging.html">

<link rel="import" href="lib/elements/kano-app-player/kano-app-player.html">
<link rel="import" href="lib/scripts/kano/app-modules/index.html">
<link rel="import" href="../web-components/kano-icons/parts.html">
<link rel="import" href="lib/elements/kano-workspace-normal/kano-workspace-normal.html">
<link rel="import" href="lib/elements/kano-workspace-lightboard/kano-workspace-lightboard.html">
<link rel="import" href="lib/elements/kano-workspace-camera/kano-workspace-camera.html">
<link rel="import" href="lib/elements/ui/kano-ui/kano-ui.html">
<link rel="import" href="./elements/kwc-code-display.html">

<!--
`kwc-art-player`
Player UI component for kano code shares.
Custom property | Description | Default
----------------|-------------|----------

@demo demo/index-app.html
-->
<dom-module id="kwc-app-player">
    <template>
        <style>
            :host {
                display: block;
                height: 100%;
            }

            :host * {
                box-sizing: border-box;
            }

            :host(.loaded) iron-image {
                opacity: 0;
            }

            :host(:not(.loaded)) kano-app-player {
                opacity: 0;
            }

            .app {
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-center-justified;
                height: 100%;
                position: relative;
            }

            iron-image {
                @apply --layout-fit;
                height: 95%;
                margin: auto;
                transition: opacity 200ms linear;
                width: 100%;
            }

            kano-app-player:not(.fullscreen) {
                @apply --layout-flex;
                padding: 8px 24px 40px 16px;
                transition: opacity 200ms linear;
                width: 100%;
            }

        </style>
        <div class="app">
            <iron-image src="[[share.cover_url]]" sizing="contain"></iron-image>
            <kano-app-player id="player"
                src="[[appUrl]]"
                slug="[[slug]]"
                on-app-ready="_onAppReady"
                show-toolbar
                layout="vertical">
                </kano-app-player>
        </div>

        <template is="dom-if" if="[[displayCode]]">
            <kwc-code-display code="[[_mdCode]]"
                              lines="[[_lines]]"
                              code-type="Javascript"
                              on-hide-code="_hideCode">
                              </kwc-code-display>
        </template>
    </template>
    <script>
        Polymer({
            is: 'kwc-app-player',
            properties: {
                code: {
                    type: String,
                    value: null
                },
                displayCode: {
                    type: Boolean,
                    value: false
                },
                _lines: {
                    type: Array,
                    computed: '_computeLines(_mdCode)'
                },
                _mdCode: {
                    type: String,
                    value: null
                },
                mode: {
                    type: String,
                    value: 'app'
                },
                share: {
                    type: Object,
                    observer: '_shareChanged'
                }
            },
            _computeLines(mdCode) {
                if (!mdCode) {
                    return [];
                }
                let newLines = mdCode.match(/\n(?!$)/g),
                    lineCount = newLines ? newLines.length : 1
                lines = Array.apply(null, {
                    length: lineCount
                }).map(Number.call, Number);
                return lines.splice(1);
            },
            _hideCode() {
                this.fire('hide-code');
            },
            _shareChanged() {
                let attachment = this.share.attachment_url,
                    workspaceInfo = this.share.workspace_info_url;
                if (attachment) {
                    this.slug = this.share.slug;
                    this.appUrl = attachment;
                }
                if (workspaceInfo) {
                    fetch(workspaceInfo)
                        .then(r => r.json())
                        .then(r => {
                            if (r.code && r.code.snapshot) {
                                let code = r.code.snapshot.javascript;
                                this.set('code', code);
                                this.set('_mdCode', '```javascript\n' + code + '\n```');
                            }
                        });
                }
            },
            _onAppReady() {
                this.toggleClass('loaded', true);
            }
        });
    </script>
</dom-module>