<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../prism-element/prism-highlighter.html">
<link rel="import" href="./highlight-theme/art.html">

<link rel="import" href="../kwc-style/typography.html">
<link rel="import" href="../kwc-style/color.html">
<link rel="import" href="../kwc-icons/kwc-icons.html">
<link rel="import" href="./elements/kwc-code-display.html">

<!--
`kwc-art-player`
Player UI component for make art shares.

@demo demo/index-art.html
-->

<dom-module id="kwc-art-player">
    <template>
        <style>
            :host * {
                box-sizing: border-box;
            }
            .player {
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-center-justified;
                height: 100%;
                position: relative;
            }
            iron-image {
                @apply --layout-vertical;
                @apply --layout-center;
                height: var(--kwc-share-player-height, 300px);
                width: var(--kwc-share-player-height, 300px);
                min-height: var(--kwc-share-player-height, 300px);
                min-width: var(--kwc-share-player-height, 300px);
            }
        </style>
        <div class="player">
            <iron-image id="image"
                        src="[[share.cover_url]]"
                        sizing="contain"
                        preload fade>
                        </iron-image>
        </div>
        <template is="dom-if" if="[[displayCode]]">
                <kwc-code-display code="[[_mdCode]]"
                                  lines="[[_lines]]"
                                  code-type="CoffeeScript"
                                  on-hide-code="_hideCode">
                                  </kwc-code-display>
        </template>
        </iron-pages>
    </template>
    <script>
        Polymer({
            is:'kwc-art-player',
            properties: {
                _code: {
                    type: String,
                    value: null
                },
                displayCode: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                _lines: {
                    type: Array,
                    computed: '_computeLines(_mdCode)'
                },
                _mdCode: {
                    type: String,
                    value: null
                },
                share: {
                    type: Object,
                    value: () => {
                        return {};
                    }
                }
            },
            observers: [
                '_shareChanged(share.*)'
            ],
            _computeLines (mdCode) {
                if (!mdCode) {
                    return [];
                }
                let newLines = mdCode.match(/\n(?!$)/g),
                    lineCount = newLines ? newLines.length : 1
                    lines =  Array.apply(null, {
                        length: lineCount
                    }).map(Number.call, Number);
                return lines.splice(1);
            },
            _hideCode () {
                this.set('displayCode', false);
                this.dispatchEvent(new CustomEvent('hide-code'));
            },
            _shareChanged () {
                let attachment = this.share.attachment_url;
                if (attachment) {
                    fetch(attachment)
                        .then(r => r.text())
                        .then(code => {
                            this._code = code;
                            this._mdCode = '```coffeescript\n' + code + '\n```';
                        });
                }
            }
        });
    </script>
</dom-module>
